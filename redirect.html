<!DOCTYPE html>
<html>
<head>
  <title>Redirecting to Campus Calendar</title>
  <script>
    // Function to get all URL parameters
    function getUrlParams() {
      const params = {};
      window.location.search.substr(1).split('&').forEach(item => {
        const [key, value] = item.split('=');
        params[key] = decodeURIComponent(value);
      });
      return params;
    }

    // Main function to handle redirection
    async function redirectToCalendar() {
      try {
        // Get all URL parameters
        const params = getUrlParams();
        
        // Extract campus location (it might be in different formats)
        let campusLocation = params.campus;
        
        // If it's not directly in the URL, we'll extract it from the original query
        if (!campusLocation && window.location.href.includes('campus_location_ca=')) {
          // Extract from the format we see in your URL
          const match = window.location.href.match(/campus_location_ca=([^&]+)/);
          if (match) {
            campusLocation = decodeURIComponent(match[1].replace(/\+/g, ' '));
          }
        }
        
        // Fetch the JSON mapping file
        const response = await fetch('https://collectivacademyadmin.github.io/hubspot-campus-calendars/campus-calendars.json');
        const data = await response.json();
        
        // Log information for debugging
        console.log("Campus detected:", campusLocation);
        console.log("Available locations:", Object.keys(data.locations));
        
        // Look up the calendar link for this campus
        if (campusLocation && data.locations[campusLocation]) {
          const calendarLink = data.locations[campusLocation].link;
          document.body.innerHTML = '<h3>Redirecting to ' + data.locations[campusLocation].name + '...</h3>';
          
          // Redirect to the calendar
          window.open(calendarLink, '_blank');
          
          // Close the iframe after 2 seconds
          setTimeout(function() {
            window.parent.postMessage(JSON.stringify({ "action": "DONE" }), "*");
          }, 2000);
        } else {
          // Default calendar or error message
          document.body.innerHTML = '<h3>No calendar found for campus: ' + (campusLocation || 'Unknown') + '</h3>' +
                                   '<p>Please make sure your campus location matches one of the following:</p>' +
                                   '<ul>' + Object.keys(data.locations).map(loc => `<li>${loc}</li>`).join('') + '</ul>';
        }
      } catch (error) {
        console.error('Error:', error);
        document.body.innerHTML = '<h3>Error loading calendar information: ' + error.message + '</h3>';
      }
    }

    // Run the redirect function when page loads
    window.onload = redirectToCalendar;
  </script>
</head>
<body>
  <h3>Redirecting to campus calendar...</h3>
</body>
</html>
